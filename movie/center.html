<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <link href="../static/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
  <link href="../static/bootstrap/css/bootstrap.css" rel="stylesheet" />
  <script src="../static/bootstrap/js/jquery-3.3.1.min.js"></script>
  <script src="../static/bootstrap/js/bootstrap.min.js"></script>
  <link rel="icon" type="image/x-icon" href="../static/images/logo.ico" />
  <link rel="stylesheet" type="text/css" href="../static/css/header.css" />
  <link rel="stylesheet" type="text/css" href="../static/css/center.css" />
  <link rel="stylesheet" type="text/css" href="../static/css/footer.css" />
  <script src="../static/js/header.js" charset="utf-8"></script>
  <script src="../static/js/Api.js"></script>
  <script src="../static/layui/layui.js" charset="utf-8"></script>
  <link rel="stylesheet" href="../static/layui/css/layui.css" media="all" />
  <title>鹰眼电影-个人中心</title>
</head>

<body>
  <!-- ------------------------------------------------------------------- -->
  <!-- 导航栏 -->
  <div id="header"></div>

  <!-- 占位符 -->
  <div style="margin-top: 110px;"></div>

  <!-- 主体 -->
  <div class="container">
    <div class="contents">
      <div class="nav-next">
        <div class="nav-title">
          <h3>个人中心</h3>
        </div>
        <a class="cardId">我的订单</a>
        <a class="cardId">基本信息</a>
        <a class="cardId">修改密码</a>
      </div>
      <div class="nav-body">
        <!-- 我的订单 -->
        <div class="one card" style="display: block;">
          <div>
            <div class="title">我的订单</div>
            <hr />
          </div>
        </div>
        <!-- 基本信息 账号、邮箱、角色、头像 -->
        <div class="two card" style="display: none;">
          <div>
            <div class="title">基本信息</div>
            <hr />
          </div>
          <div class="avatar-container layui-upload">
            <div class="layui-upload-list">
              <img class="layui-upload-img" id="demo1" />
              <p id="demoText"></p>
            </div>
            <a href="javascript:;" class="file">选择文件
              <input type="file" name="file" id="file" />
            </a>
            <div class="tips">支持JPG,JPEG,PNG格式，且文件需小于1000KB</div>
          </div>

          <div class="avatar-body"></div>
        </div>
        <!-- 修改密码 -->
        <div class="three card" style="display: none;">
          <div>
            <div class="title">修改密码</div>
            <hr />
          </div>
          <div class="avatar-body"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 脚 -->
  <div id="footer"></div>

  <!-- ------------------------------------------------------------------- -->
  <script>
    var clientHeight = document.documentElement.clientHeight;
    var user = localStorage.getItem("userJson");
    user = eval("(" + user + ")");
    var file;

    window.onload = function () {
      initCard(); //初始化选项卡
      initOrder(); //我的订单
      initInformation(); //基本信息
      initPassword(); //密码
      $("#header").load("./header.html", function () {
        initHeader();
      });

      $("#footer").load("./footer.html");
    };

    //选项卡
    function initCard() {
      var aArr = $(".nav-next").find(".cardId");
      var divArr = $(".nav-body").find(".card");
      if (localStorage.getItem("usercardId") == null) {
        localStorage.setItem("usercardId", 0);
      }
      for (var i = 0; i < aArr.length; i++) {
        aArr[i].index = i;
        aArr[i].onclick = function () {
          localStorage.setItem("usercardId", this.index);
          for (var j = 0; j < divArr.length; j++) {
            divArr[j].style.display = "none";
            aArr[j].style.cssText = "background-color: #f4f3f4; color: #333;";
          }
          divArr[this.index].style.display = "block";
          aArr[this.index].style.cssText =
            "background-color: #ed3931; color: #fff;";
        };
      }
      for (var p = 0; p < aArr.length; p++) {
        divArr[p].style.display = "none";
        aArr[p].style.cssText = "background-color: #f4f3f4; color: #333;";
        if (localStorage.getItem("usercardId") == p) {
          divArr[p].style.display = "block";
          aArr[p].style.cssText = "background-color: #ed3931; color: #fff;";
        }
      }
    }

    //初始化“我的订单”
    function initOrder() {
      var order = $(".one");
      var html;
      $.ajax({
        type: "get",
        url: url + "/order/all",
        dataType: "json",
        data: {
          userId: user.userId
        },
        success: function (obj) {
          // console.log(obj);
          for (var i = 0; i < obj.data.list.length; i++) {
            //  var order_time = obj.data[i].order_schedule.schedule_startTime.slice(0,10);
            var backetTicket = '';
            if (obj.data.list[i].orderState == 1) {
              backetTicket = '<div class="actions"><button class="layui-btn layui-btn-danger" onclick="backticket(\'' +
                obj.data.list[i].orderId +
                "','" +
                obj.data.list[i].scheduleDto.startTime +
                "','" +
                obj.data.list[i].orderStatus +
                '\')" style="cursor: pointer;text-align:center">申请退票</button></div>'
            } else {
              backetTicket = '<div class="actions"><button class="layui-btn layui-btn-disabled" style="text-align:center">申请退票</button></div>'
            }
            html =
              '<div class="order-box">' +
              '<div class="order-head">' +
              '<span class="order-date">' +
              obj.data.list[i].createTime +
              "</span>" +
              '<span class="order-id">订单号：' +
              obj.data.list[i].orderId +
              "</span>" +
              '<span class="order-delete">*</span>' +
              "</div>" +
              '<div class="order-body">' +
              '<div class="poster"><img src="' +
              obj.data.list[i].scheduleDto.movieDto.moviePicture +
              '"></div>' +
              '<div class="order-content">' +
              '<div class="movie-name">' +
              obj.data.list[i].scheduleDto.movieDto.movieCnName +
              "</div>" +
              ' <div class="cinema-name">' +
              obj.data.list[i].scheduleDto.cinemaName +
              "</div>" +
              '<div class="hall-ticket">' +
              obj.data.list[i].scheduleDto.hallName +
              " " +
              obj.data.list[i].orderPosition +
              "</div>" +
              '<div class="show-time">' +
              obj.data.list[i].scheduleDto.startTime +
              "</div>" +
              "</div>" +
              '<div class="order-price">￥' +
              obj.data.list[i].scheduleDto.price +
              "</div>" +
              '<div class="order-status">' +
              obj.data.list[i].orderStatus +
              "</div>" +
              backetTicket +
              "</div>" +
              "</div>";
            order.append(html);
          }
        }
      });
    }
    //退票申请
    function backticket(order_id, order_time, order_state) {
      var ShowTime = $(".one").find(".show-time");
      var Year,
        Month,
        Day,
        Hour,
        Mintue,
        flag = 0;
      var myDate = new Date();
      var OldTime, NowTime, OldDate, NowDate;
      if (order_state == "退票中") {
        layui.use(["layer"], function () {
          var layer = layui.layer;
          layer.alert("该订单正处于退票状态！", {
            icon: 0,
            offset: clientHeight / 5
          });
        });
      } else if (order_state == "已退票") {
        layui.use(["layer"], function () {
          var layer = layui.layer;
          layer.alert("该订单已完成退票！", {
            icon: 0,
            offset: clientHeight / 5
          });
        });
      } else {
        if (myDate.getHours() == 23) {
          flag = 1;
        }
        OldTime = order_time;
        NowTime =
          myDate.toLocaleDateString() +
          " " +
          parseInt(myDate.getHours() + 1).toString() +
          ":" +
          myDate.getMinutes();
        OldDate = new Date(OldTime.replace(/-/g, "\/"));
        NowDate = new Date(NowTime.replace(/-/g, "\/"));
        if (flag == 1) {
          flag = 0;
          layui.use(["layer"], function () {
            var layer = layui.layer;
            layer.alert("23：00 - 00：00不给予退票操作！", {
              icon: 0,
              offset: clientHeight / 5
            });
          });
        } else if (OldDate < NowDate) {
          // window.alert("旧时间：" + OldDate + "\n新时间：" + NowDate + "\n退票时间为开场前1小时外，退票申请失败！");
          layui.use(["layer"], function () {
            var layer = layui.layer;
            layer.alert("退票时间为开场前1小时外，退票申请失败！", {
              icon: 0,
              offset: clientHeight / 5
            });
          });
        } else {
          // window.alert("旧时间：" + OldDate + "\n新时间：" + NowDate + "\n退票已申请");
          layui.use(["layer"], function () {
            var layer = layui.layer;
            layer.alert(
              "是否确认要申请退票！", {
                icon: 0,
                offset: clientHeight / 5
              },
              function () {
                $.ajax({
                  type: "post",
                  url: url + "/order/applyForRefund",
                  dataType: "json",
                  data: {
                    order_id: order_id
                  },
                  success: function (obj) {
                    if (obj.code == 0) {
                      window.alert("退票已申请");
                    } else {
                      window.alert("退票申请失败！");
                    }
                  }
                });
                layer.closeAll();
                location.reload();
              }
            );
          });
        }
      }
    }

    //初始化基本信息
    function initInformation() {
      user = localStorage.getItem("userJson");
      user = eval("(" + user + ")");
      var avatarBody = $(".two").find(".avatar-body");
      avatarBody.empty();
      var roletext;
      if (user.userRole == 1) {
        roletext = "管理员";
      } else {
        roletext = "会员";
      }

      avatarBody.append(
        '<div class="userexinfo-form-section">' +
        "<p>账号：</p>" +
        "<span>" +
        '<input type="text" name="userName" id="userName" value="' +
        user.userName +
        '" disabled="false">' +
        "</span>" +
        "</div>" +
        '<div class="userexinfo-form-section">' +
        "<p>身份：</p>" +
        "<span>" +
        '<input type="text" name="role" id="role" value="' +
        roletext +
        '" disabled="false">' +
        "</span>" +
        "</div>" +
        '<div class="userexinfo-form-section">' +
        "<p>邮箱：</p>" +
        "<span>" +
        '<input type="text" name="email" id="email" value="' +
        user.userEmail +
        '">' +
        "</span>" +
        "</div>" +
        '<div class="userexinfo-btn-section">' +
        '<input type="button" onclick="saveBtn()" class="form-save-btn" value="保存">' +
        "</div>"
      );
      var HeadImg = "";
      if (
        user.userHeadImg == null ||
        typeof user.userHeadImg == "undefined"
      ) {
        HeadImg = "../upload/head/demo.jpg";
      } else {
        HeadImg = user.userHeadImg;
      }
      $("#demo1").attr("src", HeadImg);

      layui.use(["layer", "table"], function () {
        var layer = layui.layer;
        var table = layui.table;

        //图片上传
        layui.use("upload", function () {
          var $ = layui.jquery,
            upload = layui.upload;
          //普通图片上传
          var uploadInst = upload.render({
            elem: "#file",
            auto: false,
            choose: function (obj) {
              var formData = new FormData();
              //file = $("#file")[0];
              //预读本地文件
              obj.preview(function (index, fileData, result) {
                fileData.length
                formData.append("file", fileData);
                $.ajax({
                  method: "post",
                  url: url + "/file/file-upload",
                  dataType: "json",
                  contentType: false,
                  processData: false,
                  async: false,
                  data: formData,
                  success: function (obj) {
                    if (obj.data != false) {
                      file = obj.data;
                    }
                    console.log(file);
                  }
                });
                $("#demo1").attr("src", result); //图片链接（base64）
              });
            }
          });
        });
      });
    }
    //保存信息修改
    function saveBtn() {
      var formData = new FormData();
      var user_name = $("#userName").val(),
        user_role = $("#role").val(),
        user_email = $("#email").val();
      console.log(file);
      console.log(user_name + "," + user_role + "," + user_email);
      if (user_role == "会员") {
        user_role = 0;
      } else {
        user_role = 1;
      }
      if (user_email == "") {
        layui.use(["layer"], function () {
          var layer = layui.layer;
          layer.alert(
            "邮箱信息不能为空，修改失败！", {
              icon: 0,
              offset: clientHeight / 5
            },
            function () {
              layer.close(layer.index);
            }
          );
        });
      } else {
        $.ajax({
          type: "post",
          url: url + "/user/upload",
          dataType: 'json',
          contentType: 'application/json;charset=utf-8',
          data: JSON.stringify({
            userId: user.userId,
            userName: user_name,
            userRole: user_role,
            userEmail: user_email,
            userHeadImg: file
          }),
          success: function (result) {
            if (result.data != false) {
              layer.alert(
                "修改成功！", {
                  icon: 0,
                  offset: clientHeight / 5
                },
                function () {
                  localStorage.removeItem("userJson");
                  layer.closeAll();
                  localStorage.setItem("userJson", JSON.stringify(result.data));
                  initHeader();
                  initInformation();
                }
              );
            } else {
              layer.alert(
                "修改失败！", {
                  icon: 0,
                  offset: clientHeight / 5
                },
                function () {
                  layer.closeAll();
                }
              );
            }
          }
        });
      }
    }

    //初始化密码
    function initPassword() {
      var avatarBody = $(".three").find(".avatar-body");

      avatarBody.append(
        '<div class="userexinfo-form-section">' +
        "<p>旧密码：</p>" +
        "<span>" +
        '<input type="password" name="oldPassword" id="oldPassword" value="">' +
        "</span>" +
        "</div>" +
        '<div class="userexinfo-form-section">' +
        "<p>新密码：</p>" +
        "<span>" +
        '<input type="password" name="newPassword" id="newPassword" value="">' +
        "</span>" +
        "</div>" +
        '<div class="userexinfo-form-section">' +
        "<p>确认密码：</p>" +
        "<span>" +
        '<input type="password" name="repeatPassword" id="repeatPassword" value="">' +
        "</span>" +
        "</div>" +
        '<div class="userexinfo-btn-section">' +
        '<input type="submit" onclick="savePasswordBtn()" class="password-save-btn" value="保存">' +
        "</div>"
      );
    }
    //保存密码修改
    function savePasswordBtn() {
      var user_old_password = $("#oldPassword").val(),
        user_new_password = $("#newPassword").val(),
        user_repeat_password = $("#repeatPassword").val();
      var user_id = user.user_id;
      console.log(
        user_old_password +
        "," +
        user_new_password +
        "," +
        user_repeat_password
      );
      if (
        user_old_password == "" ||
        user_new_password == "" ||
        user_repeat_password == ""
      ) {
        layui.use(["layer"], function () {
          var layer = layui.layer;
          layer.alert(
            "密码修改信息不能为空，修改失败！", {
              icon: 0,
              offset: clientHeight / 5
            },
            function () {
              layer.close(layer.index);
            }
          );
        });
      } else if (user_old_password != user.user_pwd) {
        layui.use(["layer"], function () {
          var layer = layui.layer;
          layer.alert(
            "旧密码输入错误！", {
              icon: 0,
              offset: clientHeight / 5
            },
            function () {
              layer.close(layer.index);
            }
          );
        });
      } else if (user_new_password != user_repeat_password) {
        layui.use(["layer"], function () {
          var layer = layui.layer;
          layer.alert(
            "新密码和确认密码不匹配！", {
              icon: 0,
              offset: clientHeight / 5
            },
            function () {
              layer.close(layer.index);
            }
          );
        });
      } else {
        $.ajax({
          type: "post",
          url: url + "/user/modifyUserPwd",
          dataType: "json",
          data: {
            oldPwd: user_old_password,
            newPwd: user_new_password,
            user_id: user_id
          },
          success: function (obj) {
            if (obj == "success") {
              layer.alert(
                "修改成功，请重新登陆！", {
                  icon: 0,
                  offset: clientHeight / 5
                },
                function () {
                  layer.closeAll();
                  localStorage.removeItem("userJson");
                  window.location.reload();
                }
              );
            } else {
              layer.alert(
                "修改失败！", {
                  icon: 0,
                  offset: clientHeight / 5
                },
                function () {
                  layer.closeAll();
                }
              );
            }
          }
        });
      }
    }
  </script>
  <!-- ------------------------------------------------------------------- -->
</body>

</html>